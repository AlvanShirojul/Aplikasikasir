<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Angkringan (GAS & Gist)</title>
    <!-- Gunakan Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;

            /* === Background Image Optimal === */
            background-image: 
                linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.7)), /* overlay gelap */
                url("https://raw.githubusercontent.com/AlvanShirojul/aplikasikasir/main/download.jpeg");

            background-size: cover;          /* gambar menyesuaikan layar */
            background-position: center;     /* fokus ke tengah */
            background-repeat: no-repeat;
            background-attachment: fixed;    /* efek parallax */
            
            color: #ffffff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .receipt-font {
            font-family: 'Source Code Pro', monospace;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* Animasi Modal */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        /* Card Produk Styling - Glassmorphism */
        .product-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(14px) saturate(150%);
            -webkit-backdrop-filter: blur(14px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.35);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

       .product-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.18);
        }
        .product-card:active {
            transform: translateY(0);
        }
        /* .product-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        } */
        .product-name {
            font-weight: 600;
            font-size: 1.5rem;
            text-align: center;
            color: #ffffff;
            line-height: 1.4;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .product-price {
            font-weight: 700;
            font-size: 1.2rem;
            color: #00b7ff;
            margin-top: 4px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Panel Bawah Styling - Glassmorphism */
        .bottom-panel {
            background: rgba(255, 255, 255, 0.10);
            backdrop-filter: blur(14px) saturate(140%);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 -6px 25px rgba(0,0,0,0.35);
        }

        /* Button Styling */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: rgb(255, 255, 255);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Modal Styling - Glassmorphism */
        .modal-content {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            max-width: 30rem;
            width: 100%;
            animation: fadeIn 0.3s ease-out;
            color: #ffffff;
        }
        .modal-header {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .modal-subheader {
            color: #cbd5e1;
            margin-bottom: 1rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        /* Receipt Modal Styling */
        .receipt-modal-content {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            max-width: 30rem;
            width: 100%;
            font-family: 'Source Code Pro', monospace;
            color: #ffffff;
        }
        .receipt-title {
            font-weight: bold;
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 0.25rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .receipt-info {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
        }
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
            color: #ffffff;
        }
        .receipt-total {
            font-weight: bold;
            font-size: 1rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #6b7280;
            color: #ffffff;
        }

        /* History Modal Styling */
        .history-modal-content {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            max-width: 40rem;
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            color: #ffffff;
        }
        .history-header {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0.5rem;
            color: #ffffff;
        }
        .filter-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .filter-label {
            font-size: 0.875rem;
            color: #f0f4f9;
            margin-bottom: 0.5rem;
        }
        .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            color: #38adfb;
            transition: border-color 0.2s;
        }
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ffffff;
        }
        .history-item-header {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .history-item-details {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Print Styles */
        @media print {
            body > *:not(#receipt-modal) { display: none; }
            #receipt-modal {
                position: absolute; left: 0; top: 0;
                width: 100%; box-shadow: none; border: none;
                background-color: transparent !important;
            }
            #receipt-modal > div {
                max-width: none;
                width: 300px;
                margin: 0 auto;
                box-shadow: none;
                background: white;
                padding: 1rem;
                color: black;
            }
            .no-print { display: none; }
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #444;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-3 sm:p-4 pb-56">
        <header class="mb-6 sm:mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-white">App Jam Dalu</h1>
                <p class="text-gray-300 text-sm sm:text-base">Pilih produk untuk ditambahkan ke transaksi.</p>
            </div>
            <!-- Tombol Riwayat & Riwayat Hutang -->
            <div class="flex gap-2">
                <!-- Tombol Riwayat Hutang -->
                <button onclick="openHutangModal()" class="btn-danger p-1 flex items-center justify-center" title="Riwayat Hutang">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5l2 2h5a2 2 0 012 2v14a2 2 0 01-2 2z" />
                    </svg>
                </button>

                <!-- Tombol Riwayat Transaksi -->
                <button onclick="openHistoryModal()" class="btn-primary p-1 flex items-center justify-center" title="Riwayat Transaksi">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 vw" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Container Produk -->
        <div id="product-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4">
            <div id="loading-message" class="col-span-full text-center text-gray-300 py-10">
                <div class="loading-spinner mx-auto mb-3"></div>
                Memuat produk...
            </div>
        </div>
    </div>

    <!-- Panel Bawah (Keranjang dan Total) -->
    <div class="fixed bottom-0 left-0 w-full bottom-panel">
        <div class="container mx-auto p-3 sm:p-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3 md:gap-4">
                <div class="w-full md:w-1/2">
                    <div class="flex items-center gap-3 mb-1 sm:mb-2">
                        <h3 class="font-semibold text-sm text-gray-300">Keranjang (<span id="cart-count">0</span> item)</h3>
                        <!-- Tombol Undo -->
                        <button onclick="undoLastAction()" id="undo-button" class="btn-secondary text-xs disabled:opacity-50 disabled:cursor-not-allowed">&#x21A9; Undo</button>
                        <!-- Tombol Clear -->
                        <button onclick="clearCart()" id="clear-button" class="btn-danger text-xs disabled:opacity-50 disabled:cursor-not-allowed">Clear</button>
                    </div>
                    <div id="cart-items-container" class="text-xs text-gray-300 max-h-12 sm:max-h-16 overflow-y-auto pr-2">Keranjang masih kosong.</div>
                </div>
                
                <hr class="w-full border-t border-gray-700 my-2 md:hidden">

                <div class="w-full md:w-auto flex items-center justify-between gap-4 md:gap-6">
                    <div class="text-right">
                        <span class="text-sm text-gray-300">Total</span>
                        <p class="text-xl sm:text-2xl font-bold text-white">Rp <span id="total">0</span></p>
                    </div>
                    <button onclick="openCashierModal()" class="btn-primary py-3 px-5 sm:py-3 sm:px-6 text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed" id="save-button" disabled>SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pilih Kasir -->
    <div id="cashier-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content">
            <h2 class="modal-header">Pilih Kasir</h2>
            <p class="modal-subheader">Pilih nama kasir yang bertugas.</p>
            
            <select id="cashier-name" class="filter-select">
                <option value="" disabled selected>-- Pilih Kasir --</option>
                <option value="Kasir 1 (Ajis)">Ajis</option>
                <option value="Kasir 2 (Bobo)">Bobo</option>
                <option value="Owner (Alvan)">Owner (Alvan)</option>
            </select>
            
            <div class="modal-footer">
                <button onclick="closeCashierModal()" class="btn-secondary">batal</button>
                <button onclick="submithutang()" id="confirm-hutang-button" class="btn-danger">Hutang</button>
                <button onclick="submitToGAS()" id="confirm-save-button" class="btn-primary">Simpan Transaksi</button>
            </div>
        </div>
    </div>

    <!-- Modal Alert Kustom -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content text-center">
            <div id="alert-icon" class="mx-auto mb-4"></div>
            <h2 id="alert-title" class="modal-header"></h2>
            <p id="alert-message" class="modal-subheader"></p>
            <div id="alert-buttons" class="flex flex-wrap justify-center gap-3 mt-4"></div>
        </div>
    </div>

    <!-- Modal Struk -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="receipt-modal-content">
            <div id="receipt-content" class="text-sm">
                <div class="text-center mb-4">
                    <h2 class="receipt-title">SERABIH TELON</h2>
                    <p class="receipt-info">Utara Indormart Kanor Ds. Tejo Kec. Kanor Kab. Bojonegoro</p>
                </div>
                <hr class="border-dashed my-2">
                <div class="flex justify-between"><span>ID:</span><span id="receipt-id"></span></div>
                <div class="flex justify-between"><span>Tanggal:</span><span id="receipt-date"></span></div>
                <div class="flex justify-between"><span>Kasir:</span><span id="receipt-cashier"></span></div>
                <hr class="border-dashed my-2">
                <div id="receipt-items"></div>
                <hr class="border-dashed my-2">
                <div class="flex justify-between font-bold"><span>TOTAL:</span><span id="receipt-total"></span></div>
                <hr class="border-dashed my-2">
                <p class="text-center mt-4">Terima Kasih!</p>
            </div>
            <div class="p-4 bg-gray-800 flex justify-end gap-3 no-print">
                <button onclick="closeReceiptModal()" class="btn-secondary">Tutup</button>
                <button onclick="printReceipt()" class="btn-primary">Print</button>
            </div>
        </div>
    </div>

    <!-- Modal Riwayat Transaksi -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="history-modal-content">
            <div class="flex justify-between items-center history-header">
                <h2 class="font-bold text-xl">Riwayat Transaksi</h2>

                <!-- ICON FILTER -->
                <button onclick="openFilterModal()" class="p-2 rounded-lg hover:bg-white/20 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 01.78 1.625L14 13.5V19a1 1 0 01-1.447.894l-4-2A1 1 0 018 17V13.5L3.22 5.625A1 1 0 013 4z" />
                    </svg>
                </button>
            </div>
            <div id="history-content" class="overflow-y-auto flex-grow space-y-3 pr-2">
                <p id="history-loading" class="text-center text-gray-300 py-10">Memuat data...</p>
            </div>
            
            <div class="p-4 flex justify-between items-center border-t mt-4">
                <button onclick="closeHistoryModal()" class="btn-secondary">Tutup</button>

                <p class="text-right text-white text-sm">
                    Total: <span id="history-total" class="font-bold text-blue-300">Rp 0</span>
                </p>
            </div>
        </div>
    </div>
    <!-- Modal Riwayat Hutang -->
    <div id="hutang-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="history-modal-content">
            <div class="flex justify-between items-center history-header">
                <h2 class="font-bold text-xl">Riwayat Hutang Pelanggan</h2>
            </div>

            <div id="hutang-content" class="overflow-y-auto flex-grow space-y-3 pr-2">
                <p class="text-center text-gray-300 py-10">Memuat data...</p>
            </div>

            <div class="p-4 flex justify-between items-center border-t mt-4">
                <button onclick="closeHutangModal()" class="btn-secondary">Tutup</button>
                <p class="text-right text-white text-sm">
                    Total Hutang: <span id="hutang-total" class="font-bold text-red-400">Rp 0</span>
                </p>
            </div>
        </div>
    </div>
    <!-- MODAL FILTER -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content max-w-md w-full">
            <h3 class="modal-header text-center">Filter Riwayat</h3>
            <div class="mt-3">
                <label class="filter-label">Pilih Kasir</label>
                <select id="filter-cashier-modal" class="filter-select">
                    <option value="all">Semua Kasir</option>
                    <option value="Kasir 1 (Ajis)">Kasir 1 (Ajis)</option>
                    <option value="Kasir 2 (Bobo)">Kasir 2 (Bobo)</option>
                    <option value="Owner (Alvan)">Owner (Alvan)</option>
                </select>
            </div>

            <div class="modal-footer">
                <button onclick="closeFilterModal()" class="btn-secondary">Batal</button>
                <button onclick="applyFilterModal()" class="btn-primary">Terapkan</button>
            </div>

        </div>
    </div>

<script>
/* ------------------------------------------------------------
   KONFIGURASI URL API
------------------------------------------------------------ */
const GIST_URL_GET_PRODUCTS = "https://gist.githubusercontent.com/AlvanShirojul/b9f400f45a704f46621270287c26ac51/raw/6bf309946bb55f4cb8f26b8800d4acc39746889a/Angkringan.json";
const TargetUrl = "https://script.google.com/macros/s/AKfycbxldYba5CuCKZQULho9IXGV7kaKvFOBrwdAF8_JAxkbThbUTx2kmCB-31is3fyXbapUQA/exec";
const ProxyUrl = "https://spring-frog-1892.alpansirojul.workers.dev/?url=";

/* ------------------------------------------------------------
   VARIABEL GLOBAL
------------------------------------------------------------ */
let cart = [];
let actionHistory = [];
let lastTransactionData = null;
let isSaving = false;
let allHistoryData = []; // Menyimpan semua data riwayat dari server

/* ------------------------------------------------------------
   UTILITAS & ELEMENT DOM
------------------------------------------------------------ */
const el = (id) => document.getElementById(id);
const productContainer = el('product-container');
const loadingMessage = el('loading-message');
const totalElement = el('total');
const cartCountElement = el('cart-count');
const cartItemsContainer = el('cart-items-container');
const saveButton = el('save-button');
const undoButton = el('undo-button');
const clearButton = el('clear-button');
const cashierModal = el('cashier-modal');
const alertModal = el('alert-modal');
const receiptModal = el('receipt-modal');
const historyModal = el('history-modal');
const historyContent = el('history-content');

/* ------------------------------------------------------------
   SAAT HALAMAN DIMUAT
------------------------------------------------------------ */
window.onload = () => {
  fetchProducts();
};

/* ------------------------------------------------------------
   FUNGSI PRODUK (dari Gist)
------------------------------------------------------------ */
async function fetchProducts() {
  try {
    const res = await fetch(GIST_URL_GET_PRODUCTS);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const products = await res.json();

    loadingMessage.style.display = 'none';
    productContainer.innerHTML = '';

    if (!products.length) {
      productContainer.innerHTML = '<div class="col-span-full text-center text-gray-300 py-10">Belum ada produk dimuat dari Gist.</div>';
      return;
    }

    products.forEach((p, index) => {
      const btn = document.createElement('button');
      btn.className = "product-card";
      btn.innerHTML = `
        <div class="product-name">${p.name}</div>
        <div class="product-price">Rp ${p.price.toLocaleString('id-ID')}</div>`;

      // ðŸ”¥ PERBAIKAN PENTING â†’ ID DI-PAKSA JADI STRING
      btn.onclick = () => addToCart(String(p.id ?? `NOID-${index}`), p.name, p.price);

      productContainer.appendChild(btn);
    });
  } catch (err) {
    console.error("Error fetching products from Gist:", err);
    loadingMessage.innerHTML = `<span class="text-red-400">Gagal memuat produk dari Gist: ${err.message}</span>`;
  }
}

/* ------------------------------------------------------------
   FUNGSI KERANJANG
------------------------------------------------------------ */
function addToCart(id, name, price) {
  // debug
  console.log("ADD CART:", id, name, price);

  // ensure types
  const pid = String(id);
  const pname = String(name);
  const pprice = Number(price) || 0;

  actionHistory.push({ id: pid, name: pname, price: pprice });
  updateCart();
}

function undoLastAction() {
  if (actionHistory.length > 0) {
    actionHistory.pop();
    updateCart();
  }
}

function clearCart() {
  if (actionHistory.length === 0) return;

  showAlert(
    'error',
    'tenan to gak?',
    'di input sek, seeng bener !!!',
    `
      <button onclick="confirmClearCart()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Ya, Hapus</button>
      <button onclick="closeAlertModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg transition">Batal</button>
    `
  );
}

function confirmClearCart() {
  actionHistory = [];
  updateCart();
  closeAlertModal();
}

function buildCartFromHistory() {
  const grouped = new Map();

  actionHistory.forEach(item => {
    const key = String(item.id);
    if (grouped.has(key)) {
      grouped.get(key).quantity++;
    } else {
      // copy and ensure numeric price
      grouped.set(key, { id: key, name: item.name, price: Number(item.price) || 0, quantity: 1 });
    }
  });

  return Array.from(grouped.values());
}

function updateCart() {
  cart = buildCartFromHistory();

  // ensure quantities & prices are numbers
  cart = cart.map(i => ({ id: String(i.id), name: i.name, price: Number(i.price) || 0, quantity: Number(i.quantity) || 0 }));

  const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
  const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);

  totalElement.textContent = total.toLocaleString('id-ID');
  cartCountElement.textContent = totalItems;

  const empty = cart.length === 0;
  saveButton.disabled = empty || isSaving;
  undoButton.disabled = empty;
  clearButton.disabled = empty;

  cartItemsContainer.innerHTML = empty
    ? 'Keranjang masih kosong.'
    : cart.map(i => `<span class="bg-gray-700 py-0.5 px-1.5 rounded-full text-gray-200">${escapeHtml(i.name)} <span class="text-blue-400 font-semibold">x${i.quantity}</span></span>`).join(' ');

  // debug
  console.log("CART NOW:", cart);
}

/* ------------------------------------------------------------
   FUNGSI MODAL SIMPAN TRANSAKSI (Kasir)
------------------------------------------------------------ */
function openCashierModal() {
  if (cart.length === 0) {
    showAlert('error', 'Keranjang Kosong', 'Silakan tambahkan produk terlebih dahulu.');
    return;
  }
  cashierModal.classList.remove('hidden');
  el('cashier-name').focus();
}

function closeCashierModal() {
  cashierModal.classList.add('modal-leave');
  setTimeout(() => {
    cashierModal.classList.add('hidden');
    cashierModal.classList.remove('modal-leave');
  }, 300);
}

/* ------------------------------------------------------------
   FUNGSI SUBMIT KE GAS
------------------------------------------------------------ */
async function submitToGAS() {
  const confirmBtn = el('confirm-save-button');
  const cashier = el('cashier-name').value.trim();

  if (!cashier) {
    showAlert('error', 'Kasir belum dipilih', 'Pilih nama kasir sebelum menyimpan transaksi.');
    return;
  }

  if (cart.length === 0) {
    showAlert('error', 'Keranjang Kosong', 'Tambahkan produk sebelum menyimpan.');
    return;
  }

  // ensure numbers
  const total = cart.reduce((sum, i) => sum + (Number(i.price) * Number(i.quantity)), 0);
  const transactionId = `TRX-${Date.now().toString().slice(-8)}`;
  const transactionDate = new Date().toISOString();

  // prepare items: ensure fields names expected by GAS (quantity not qty)
  const itemsToSend = cart.map(i => ({
    id: String(i.id),
    name: i.name,
    price: Number(i.price) || 0,
    quantity: Number(i.quantity) || 0
  }));

  const transactionData = {
    id: transactionId,
    cashier: cashier,
    total: total,
    date: transactionDate,
    items: itemsToSend
  };

  // debug final payload
  console.log("SUBMIT PAYLOAD:", transactionData);

  try {
    isSaving = true;
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Menyimpan...";

    const res = await fetch(ProxyUrl + encodeURIComponent(TargetUrl), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(transactionData)
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`HTTP ${res.status} - ${errorText}`);
    }
    const responseData = await res.json();
    if (responseData.status !== 'success') {
      throw new Error(responseData.message || 'Gagal menyimpan transaksi.');
    }

    lastTransactionData = transactionData;

    showAlert('success', 'Transaksi Tersimpan', 'Data transaksi berhasil dikirim ke server.',
      `<button onclick="showReceipt()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Cetak Struk</button>
       <button onclick="closeAlertModal(); closeCashierModal(); actionHistory = []; updateCart();" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">OK</button>`
    );

  } catch (err) {
    console.error("Error submitting to GAS:", err);
    showAlert('error', 'Gagal Mengirim ke Server', `Terjadi kesalahan: ${escapeHtml(err.message)}`);
  } finally {
    isSaving = false;
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Simpan Transaksi";
  }
}
/* ------------------------------------------------------------
   FUNGSI SIMPAN HUTANG KE SHEET "Hutang_Pelanggan"
------------------------------------------------------------ */
async function submithutang() {
  const confirmBtn = el('confirm-hutang-button');
  const cashier = el('cashier-name').value.trim();

  if (!cashier) {
    showAlert('error', 'Kasir belum dipilih', 'Pilih nama kasir sebelum mencatat hutang.');
    return;
  }

  if (cart.length === 0) {
    showAlert('error', 'Keranjang Kosong', 'Tambahkan produk sebelum menyimpan hutang.');
    return;
  }

  // Minta nama pelanggan
  const debtor = prompt("Masukkan nama pelanggan yang berhutang:");
  if (!debtor) {
    showAlert('error', 'Nama belum diisi', 'Masukkan nama pelanggan terlebih dahulu.');
    return;
  }

  // Buat ID dan tanggal transaksi
  const transactionId = `HUT-${Date.now().toString().slice(-8)}`;
  const transactionDate = new Date().toLocaleString('id-ID');

  // Bentuk struktur data seperti transaksi biasa + nama pelanggan & status
  const hutangRows = cart.map(item => ({
    tanggal: transactionDate,
    id_transaksi: transactionId,
    id_produk: item.id,
    nama_produk: item.name,
    qty: item.quantity,
    harga: item.price,
    subtotal: item.price * item.quantity,
    nama_pelanggan: debtor,
    kasir: cashier,
    status: "Belum Lunas"
  }));

  try {
    isSaving = true;
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Menyimpan...";

    // âœ… Gunakan proxy yang sama seperti GET transaksi
    const res = await fetch(ProxyUrl + encodeURIComponent(TargetUrl), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: "saveHutang", // flag agar diarahkan ke sheet Hutang_Pelanggan
        data: hutangRows
      })
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`HTTP ${res.status} - ${errorText}`);
    }

    const response = await res.json();
    if (response.status !== 'success') {
      throw new Error(response.message || 'Gagal menyimpan hutang.');
    }

    showAlert(
      'success',
      'Hutang Tersimpan',
      `Hutang atas nama <b>${debtor}</b> sebesar <b>Rp ${hutangRows.reduce((s, i) => s + i.subtotal, 0).toLocaleString('id-ID')}</b> telah disimpan di daftar hutang.`,
      `<button onclick="closeAlertModal(); closeCashierModal(); actionHistory = []; updateCart();" 
        class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">OK</button>`
    );

  } catch (err) {
    console.error("Error simpan hutang:", err);
    showAlert('error', 'Gagal Menyimpan Hutang', `Terjadi kesalahan: ${escapeHtml(err.message)}`);
  } finally {
    isSaving = false;
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Hutang";
  }
}
/* ------------------------------------------------------------
   FUNGSI RIWAYAT TRANSAKSI (dari GAS)
   Note: Apps Script returns { status, history }
   where history = array of line-item rows (per product)
------------------------------------------------------------ */
async function openHistoryModal() {
  historyModal.classList.remove('hidden');
  await fetchHistory();
  applyHistoryFilter();
}
function openFilterModal() {
    el("filter-modal").classList.remove("hidden");
}
/* ------------------------------------------------------------
   FUNGSI RIWAYAT HUTANG (Menampilkan per transaksi)
------------------------------------------------------------ */
async function openHutangModal() {
  const modal = el('hutang-modal');
  const content = el('hutang-content');
  const totalDisplay = el('hutang-total');

  modal.classList.remove('hidden');
  content.innerHTML = '<p class="text-center text-gray-300 py-10">Memuat data hutang...</p>';

  try {
    // Ambil data hutang dari GAS (via proxy)
    const res = await fetch(`${ProxyUrl}${TargetUrl}?action=hutang&_=${Date.now()}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    let history = data.history || [];
        history = history.filter(row => {
    const status = String(row["Status"] || "").trim().toLowerCase();
    return status !== "lunas"; // tampilkan hanya yang belum lunas
    });
    if (!history.length) {
      content.innerHTML = '<p class="text-center text-gray-400 py-10">Belum ada data hutang pelanggan.</p>';
      totalDisplay.textContent = "Rp 0";
      return;
    }

    // ðŸ”¹ 1. Kelompokkan berdasarkan ID Transaksi
    const grouped = new Map();
    history.forEach(row => {
      const id = String(row["ID Transaksi"] || "").trim();
      if (!id) return;

      if (!grouped.has(id)) {
        grouped.set(id, {
          id,
          tanggal: row["Tanggal"] || "",
          pelanggan: row["Pelanggan"] || row["Nama Pelanggan"] || "-",
          kasir: row["Cashier"] || row["Kasir"] || "-",
          status: row["Status"] || "Belum Lunas",
          total: 0,
          items: []
        });
      }

      const trx = grouped.get(id);
      const qty = Number(row["Qty"] || 0);
      const harga = Number(row["Harga"] || 0);
      const subtotal = Number(row["Subtotal"] || 0);

      trx.total += subtotal;
      trx.items.push({
        idProduk: row["ID Produk"] || "",
        namaProduk: row["Nama Produk"] || "",
        qty,
        harga,
        subtotal
      });
    });

    // ðŸ”¹ 2. Ubah Map â†’ Array
    const transactions = Array.from(grouped.values());

    // ðŸ”¹ 3. Hitung total seluruh hutang
    const totalSemua = transactions.reduce((sum, t) => sum + t.total, 0);
    totalDisplay.textContent = "Rp " + totalSemua.toLocaleString("id-ID");

    // ðŸ”¹ 4. Render hasil ke HTML
    content.innerHTML = "";
    transactions.forEach(trx => {
      const itemsList = trx.items.map(i => `
        <li class="flex justify-between text-sm text-gray-300 border-b border-gray-700 py-1">
          <span>${escapeHtml(i.namaProduk)} <span class="text-gray-500">x${i.qty}</span></span>
          <span>Rp ${i.subtotal.toLocaleString("id-ID")}</span>
        </li>
      `).join("");

      const card = document.createElement("div");
      card.className = "bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-md hover:shadow-lg transition-all mb-4";
      card.innerHTML = `
        <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-2">
          <span class="font-bold text-lg text-white">#${escapeHtml(trx.id)}</span>
          <span class="text-xs text-gray-400">${escapeHtml(trx.tanggal)}</span>
            </div>
            <div class="text-sm text-gray-200 mb-1">
          <span class="font-semibold">Pelanggan:</span> ${escapeHtml(trx.pelanggan)}
        </div>
        <div class="flex justify-between items-center mb-1">
          <div class="text-sm text-gray-200">
            <span class="font-semibold">Kasir:</span> ${escapeHtml(trx.kasir)}
          </div>
          <button onclick="markAsLunas('${trx.id}')" 
            class="text-xs px-3 py-1 rounded-lg bg-green-600/70 hover:bg-green-500/80 border border-white/20 text-white backdrop-blur-sm transition-all">
            Tandai Lunas
          </button>
        </div>

        <ul class="mt-2 border-t border-gray-700 pt-2">${itemsList}</ul>
        <div class="flex justify-between items-center mt-3 border-t border-gray-700 pt-2">
          <span class="font-semibold text-blue-300">Total Hutang:</span>
          <span class="font-bold text-lg text-blue-400">Rp ${trx.total.toLocaleString("id-ID")}</span>
        </div>
        <div class="mt-2 text-right">
          <span class="text-xs px-2 py-1 rounded-md ${
            trx.status === "Lunas" ? "bg-green-600" : "none"
          } text-white">${trx.status}</span>
        </div>
      `;
      content.appendChild(card);
    });
  } catch (err) {
    console.error("fetch hutang error:", err);
    content.innerHTML = `<p class="text-center text-red-400 py-10">Gagal memuat data hutang: ${escapeHtml(err.message)}</p>`;
  }
}
/* ------------------------------------------------------------
   FUNGSI: Tandai Hutang Sebagai Lunas
------------------------------------------------------------ */
async function markAsLunas(trxId) {
  if (!confirm(`Apakah kamu yakin ingin menandai transaksi ${trxId} sebagai Lunas?`)) return;

  try {
    // Tombol loading (opsional)
    const button = event.target;
    button.disabled = true;
    button.textContent = "Memproses...";

    // Kirim ke Apps Script lewat proxy
    const res = await fetch(ProxyUrl + encodeURIComponent(TargetUrl), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: "updateHutang",
        id_transaksi: trxId
      })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.status !== "success") throw new Error(data.message);

    // âœ… Berhasil
    alert(`Transaksi ${trxId} telah diperbarui menjadi Lunas.`);
    openHutangModal(); // Refresh ulang tampilan daftar hutang
  } catch (err) {
    console.error("markAsLunas error:", err);
    alert("Gagal memperbarui status: " + err.message);
  }
}
function closeHutangModal() {
  const modal = el('hutang-modal');
  modal.classList.add('modal-leave');
  setTimeout(() => {
    modal.classList.add('hidden');
    modal.classList.remove('modal-leave');
  }, 300);
}

function closeFilterModal() {
    el("filter-modal").classList.add("modal-leave");
    setTimeout(() => {
        el("filter-modal").classList.add("hidden");
        el("filter-modal").classList.remove("modal-leave");
    }, 250);
}

function applyFilterModal() {
    applyHistoryFilter();
    closeFilterModal();
}


function closeHistoryModal() {
  historyModal.classList.add('modal-leave');
  setTimeout(() => {
    historyModal.classList.add('hidden');
    historyModal.classList.remove('modal-leave');
  }, 300);
}

async function fetchHistory() {
  historyContent.innerHTML = '<p class="text-center text-gray-300 py-10">Memuat data...</p>';
  try {
    const res = await fetch(`${ProxyUrl}${TargetUrl}?action=history&_=${Date.now()}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    // Apps Script returns { status: 'success', history: [...] }
    allHistoryData = data.history || [];
  } catch (err) {
    console.error("fetchHistory error:", err);
    historyContent.innerHTML = `<p class="text-center text-red-400 py-10">Gagal memuat riwayat: ${escapeHtml(err.message)}</p>`;
  }
}

function applyHistoryFilter() {
  const selectedCashier = el('filter-cashier-modal') 
      ? el('filter-cashier-modal').value 
      : 'all';
  const now = new Date();
  const twentyHoursAgo = new Date(now.getTime() - (15 * 60 * 60 * 1000));

  // allHistoryData is array of line-items. Group by ID Transaksi to produce transactions.
  const txMap = new Map();
  allHistoryData.forEach(row => {
    const trxId = String(row['ID Transaksi'] ?? row['ID'] ?? row['ID Transaksi'] ?? 'UNKNOWN');
    const trxDateRaw = row['Tanggal'] || row['tanggal'] || row['Date'] || null;
    const cashier = row['Cashier'] || row['cashier'] || row['Kasir'] || '';

    const qty = Number(row['Qty'] ?? row['qty'] ?? row['quantity'] ?? 0) || 0;
    const price = Number(row['Harga'] ?? row['harga'] ?? row['price'] ?? 0) || 0;
    const subtotal = Number(row['Subtotal'] ?? row['subtotal'] ?? qty * price) || (qty * price);

    if (!txMap.has(trxId)) {
      txMap.set(trxId, {
        id: trxId,
        date: trxDateRaw ? new Date(trxDateRaw) : new Date(),
        cashier: cashier,
        total: 0,
        items: []
      });
    }
    const tx = txMap.get(trxId);
    tx.total += subtotal;
    tx.items.push({
      id: row['ID Produk'] || row['id produk'] || row['ID'] || row['id'] || '',
      name: row['Nama Produk'] || row['nama produk'] || row['name'] || row['nama'] || '',
      qty: qty,
      price: price,
      subtotal: subtotal
    });
  });

  // Convert map to array and apply time + cashier filter
  let txs = Array.from(txMap.values());
  txs = txs.filter(t => {
    const timeMatch = new Date(t.date) >= twentyHoursAgo;
    const cashierMatch = selectedCashier === 'all' || !selectedCashier || t.cashier === selectedCashier;
    return timeMatch && cashierMatch;
  });

  // Sort newest first
  txs.sort((a, b) => new Date(b.date) - new Date(a.date));

  renderHistory(txs);
}

function renderHistory(transactions) {
  // Hitung total transaksi
  const sumTotal = transactions.reduce((sum, tx) => sum + (Number(tx.total) || 0), 0);
  el("history-total").textContent = "Rp " + sumTotal.toLocaleString("id-ID");

  if (!transactions.length) {
    historyContent.innerHTML = '<p class="text-center text-gray-300 py-10">Tidak ada transaksi yang sesuai filter.</p>';
    return;
  }
  historyContent.innerHTML = '';
  transactions.forEach(trx => {
    const total = Number(trx.total || 0).toLocaleString('id-ID');
    const tgl = new Date(trx.date).toLocaleString('id-ID');
    const cashier = trx.cashier || '-';
    const itemsText = trx.items.map(i => `${escapeHtml(i.name)} x${i.qty}`).join(', ');
    const card = document.createElement('div');
    card.className = "bg-gray-800 border border-gray-700 rounded-lg p-3 shadow-sm hover:shadow-md transition-all";
    card.innerHTML = `
      <div class="flex justify-between items-center border-b pb-2 mb-2">
        <span class="font-bold text-lg text-white">Rp ${total}</span>
        <span class="text-xs text-gray-400">${tgl}</span>
      </div>
      <p class="text-sm text-gray-200 mb-1"><span class="font-semibold">Kasir:</span> ${escapeHtml(cashier)}</p>
      <p class="text-xs text-gray-500 truncate">Items: ${itemsText}</p>`;
    historyContent.appendChild(card);
  });
}

/* ------------------------------------------------------------
   FUNGSI STRUK & ALERT
------------------------------------------------------------ */
function showReceipt() {
  closeAlertModal();
  if (!lastTransactionData) return;

  const { id, date, cashier, total, items } = lastTransactionData;
  el('receipt-id').textContent = id;
  el('receipt-date').textContent = new Date(date).toLocaleString('id-ID');
  el('receipt-cashier').textContent = cashier;
  el('receipt-total').textContent = `Rp ${Number(total).toLocaleString('id-ID')}`;

  el('receipt-items').innerHTML = items.map(i => `
      <div class="flex justify-between text-white">
        <span>${escapeHtml(i.name)}</span>
        <span>${(Number(i.quantity) * Number(i.price)).toLocaleString('id-ID')}</span>
      </div>
      <div class="flex justify-end text-xs text-gray-400">
        ${Number(i.quantity)} x ${Number(i.price).toLocaleString('id-ID')}
      </div>`).join('');
  receiptModal.classList.remove('hidden');
}

function closeReceiptModal() {
  receiptModal.classList.add('modal-leave');
  setTimeout(() => {
    receiptModal.classList.add('hidden');
    receiptModal.classList.remove('modal-leave');
    location.reload(); // refresh halaman setelah menutup struk
  }, 300);
}

function printReceipt() { window.print(); }

function showAlert(type, title, message, buttons = `<button onclick="closeAlertModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">OK</button>`) {
  el('alert-title').textContent = title;
  el('alert-message').innerHTML = message;
  el('alert-icon').innerHTML = type === 'success'
    ? `<svg class="w-16 h-16 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
    : `<svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
  el('alert-buttons').innerHTML = buttons;
  alertModal.classList.remove('hidden');
}

function closeAlertModal() {
  alertModal.classList.add('modal-leave');
  setTimeout(() => {
    alertModal.classList.add('hidden');
    alertModal.classList.remove('modal-leave');
  }, 300);
}

/* ------------------------------------------------------------
   UTIL: escape HTML untuk keamanan tampilan
------------------------------------------------------------ */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
